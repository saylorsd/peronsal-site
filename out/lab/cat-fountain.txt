4:"$Sreact.fragment"
5:I[4839,["839","static/chunks/839-a02b813799836efe.js","970","static/chunks/970-2578be30f9e9c47c.js","378","static/chunks/app/lab/page-90cd8df9f7b5d9f4.js"],""]
6:I[5244,[],""]
7:I[3866,[],""]
9:I[6213,[],"OutletBoundary"]
b:I[6213,[],"MetadataBoundary"]
d:I[6213,[],"ViewportBoundary"]
f:I[4835,[],""]
1:HL["/_next/static/media/618564c0002d7eaf-s.p.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
2:HL["/_next/static/media/c1ab11b3d2850569-s.p.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
3:HL["/_next/static/css/55125ab23a56bb82.css","style"]
0:{"P":null,"b":"lcPn4lbw7rqgz4YJ3OHGV","p":"","c":["","lab","cat-fountain"],"i":false,"f":[[["",{"children":["lab",{"children":[["slug","cat-fountain","d"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$4","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/55125ab23a56bb82.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","className":"__variable_8a0362 ","children":["$","body",null,{"children":["$","div",null,{"className":"container mx-auto max-w-3xl","children":[["$","header",null,{"className":"mt-8 mb-2 border-b-4 pb-0.5","children":[["$","div",null,{"children":[["$","h1",null,{"className":"text-5xl font-bold","children":"Steve Saylor "}],["$","div",null,{"className":"mt-2 italic text-stone-700","children":"full-stack developer, civic technologist"}]]}],["$","nav",null,{"className":"border-b-2 py-[2ch]","children":["$","ul",null,{"className":"flex gap-4","children":[["$","li",null,{"children":["$","$L5",null,{"href":"/","className":"hover:bg-cyan-200","target":"$undefined","children":["$","span",null,{"className":"underline hover:decoration-2 hover:decoration-off ","children":"Home"}]}]}],["$","li",null,{"children":["$","$L5",null,{"href":"/portfolio","className":"hover:bg-cyan-200","target":"$undefined","children":["$","span",null,{"className":"underline hover:decoration-2 hover:decoration-off ","children":"Portfolio"}]}]}],["$","li",null,{"children":["$","$L5",null,{"href":"/lab","className":"hover:bg-cyan-200","target":"$undefined","children":["$","span",null,{"className":"underline hover:decoration-2 hover:decoration-off ","children":"Side Projects"}]}]}],["$","li",null,{"children":["$","$L5",null,{"href":"/bit","className":"hover:bg-cyan-200","target":"$undefined","children":["$","span",null,{"className":"underline hover:decoration-2 hover:decoration-off ","children":"Bit"}]}]}]]}]}]]}],["$","main",null,{"className":"mt-12","children":["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[]}]}]]}]}]}]]}],{"children":["lab",["$","$4","c",{"children":[null,["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children","lab","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]]}],{"children":[["slug","cat-fountain","d"],["$","$4","c",{"children":[null,["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children","lab","children","$0:f:0:1:2:children:2:children:0","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]]}],{"children":["__PAGE__",["$","$4","c",{"children":["$L8",null,["$","$L9",null,{"children":"$La"}]]}],{},null]},null]},null]},null],["$","$4","h",{"children":[null,["$","$4","hV_RkzH2YlZk77B9WxnfD",{"children":[["$","$Lb",null,{"children":"$Lc"}],["$","$Ld",null,{"children":"$Le"}],["$","meta",null,{"name":"next-size-adjust"}]]}]]}]]],"m":"$undefined","G":["$f","$undefined"],"s":false,"S":true}
e:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
c:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Steve Saylor"}],["$","meta","2",{"name":"description","content":"Website for Steve Saylor, full stack developer"}],["$","meta","3",{"name":"application-name","content":"Next.js"}],["$","meta","4",{"name":"author","content":"Steve Saylor"}],["$","meta","5",{"name":"generator","content":"Next.js"}],["$","meta","6",{"name":"keywords","content":"developer,Next.js,React,TypeScript,GIS,geospatial,civic technology"}],["$","meta","7",{"name":"referrer","content":"origin-when-cross-origin"}],["$","meta","8",{"name":"publisher","content":"Steve Saylor"}]]
a:null
10:I[7970,["970","static/chunks/970-2578be30f9e9c47c.js","178","static/chunks/app/lab/%5Bslug%5D/page-67c781670e30e7bc.js"],"Image"]
11:T2efb,<p>I have one of <a href="https://petkit.com/products/eversweet-solo-2">these water fountains</a> for my cat. It comes with an app,
and from what I could tell, it was using Bluetooth Low Energy (Bluetooth LE, BLE) for communicating with the fountain. I
really don't
want to use the company's app for privacy and security reasons. I also think that reverse engineering the fountain's API
will lead to other fun projects like building a new app and integrating my own smart home features.</p>
<p>So far, I've been able to reverse engineer a bit of how the fountain and app work. Here's my best attempt collect
notes and document what I did a while ago. It is not complete, but I plan to clean this up and add more in the future.</p>
<h2>Packet Sniffing</h2>
<p>I knew I would need to sniff the packets being sent between my phone and the fountain. Some web searching led
me <a href="https://novelbits.io/nordic-ble-sniffer-guide-using-nrf52840-wireshark/">a post</a> which led me to try
the packet sniffing software <a href="https://www.wireshark.org/">Wireshark</a> with a BLE plugin, and
a <a href="https://www.nordicsemi.com/Products/Development-hardware/nrf52840-dongle">nRF52840 BLE development dongle</a> from
Nordic Semiconductor.</p>
<p>To use the dongle to sniff packets (i.e. simply listen to and report them), I need to install
the <a href="https://www.nordicsemi.com/Products/Development-tools/nRF-Sniffer-for-Bluetooth-LE">sniffer firmware</a>
using <a href="https://www.nordicsemi.com/Products/Development-tools/nRF-Connect-for-Desktop">Nordic's desktop software</a>.</p>
<figure>
<img src="/images/side-projects/cat-fountain/nrf.gif" height="400px" alt="NRF dongle sniffing away">
<figcaption>nRF dongle sniffing packets</figcaption>
</figure>

<p>With the sniffer running in wireshark without any further filtering, I was looking at a firehose of all the bluetooth
packets flying around me. Luckily wireshark allows for lots of filters and I could filter to just the packets from and
for the fountain.</p>
<figure>
<img src="/images/side-projects/cat-fountain/sniffing.gif" alt="Sniffing">
<figcaption>Wireshark output of communications between fountain and my phone</figcaption>
</figure>


<p>The next thing I did was explore the packets while playing with the app. I discovered that communication was done
using <a href="https://en.wikipedia.org/wiki/Bluetooth_Low_Energy#Software_model">GATT</a> and from there I was able to narrow now
the packets to the ones I wanted as Wireshark labeled the protocol being used in the packet.</p>
<p>Exploring the (G)ATT packets I found the payload data being sent and started to explore it. I updated Wireshark to
report the payload data and then I exported it to excel to play around with it.</p>
<h2>Examining raw data</h2>
<h3>Fountain control commands</h3>
<p>I started playing with the data and a <a href="https://bleak.readthedocs.io/en/latest/">Python BLE library</a> and was able to
reverse engineer the On/Off switch of the fountain. One interesting thing I noticed was a few bytes used to keep track
of a sequence. If you send a command with teh sequence bytes behind, the fountain will ignore it.</p>
<p><em>This python script shows my breakdown of the bytes sent by the app and can send on and off requests to the fountain.</em></p>
<pre><code class="hljs language-python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">from</span> bleak <span class="hljs-keyword">import</span> BleakClient, BleakScanner, BleakGATTCharacteristic

NAME = <span class="hljs-string">'Petkit_CTW2'</span>

<span class="hljs-comment"># CHARACTERISTICS</span>
CHAR13 = <span class="hljs-string">'0000aaa2-0000-1000-8000-00805f9b34fb'</span>  <span class="hljs-comment"># Petkit_CTW2_TX</span>
CHAR16 = <span class="hljs-string">'0000aaa1-0000-1000-8000-00805f9b34fb'</span>  <span class="hljs-comment"># Petkit_CTW2_RX</span>

<span class="hljs-comment"># DESCRIPTORS</span>
DESC15 = <span class="hljs-string">'00002901-0000-1000-8000-00805f9b34fb'</span>  <span class="hljs-comment"># CHAR13  - bytearray(b'Petkit_CTW2_TX')</span>
DESC18 = <span class="hljs-string">'00002902-0000-1000-8000-00805f9b34fb'</span>  <span class="hljs-comment"># CHAR16  - bytearray(b'')</span>
DESC19 = <span class="hljs-string">'00002901-0000-1000-8000-00805f9b34fb'</span>  <span class="hljs-comment"># CHAR16  - bytearray(b'Petkit_CTW2_RX')</span>

<span class="hljs-comment"># SERVICES</span>
SERV12 = <span class="hljs-string">'0000aaa0-0000-1000-8000-00805f9b34fb'</span>

<span class="hljs-comment"># DATA PARTS</span>
MAGIC_NUMBER = <span class="hljs-string">b'\xFA\xFC\xFD'</span>
PAUSE_CMD = <span class="hljs-string">b'\xDC'</span>
SOMETHING = <span class="hljs-string">b'\x02\x00'</span>
ON = <span class="hljs-string">b'\x01'</span>
OFF = <span class="hljs-string">b'\x00'</span>
END = <span class="hljs-string">b'\x01\xFB'</span>

DIR = Path(os.path.dirname(os.path.realpath(__file__)))

INIT_CMD = <span class="hljs-string">b'\xD5'</span>

INIT_MESSAGE = MAGIC_NUMBER  + INIT_CMD + <span class="hljs-string">b'\x01\x00\x00\x00\xfb'</span>


WRITE_CHAR = CHAR13
READ_CHAR = CHAR16


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_next_sequence</span>() -&gt; <span class="hljs-built_in">int</span>:
    file_name = DIR / <span class="hljs-string">'sequence'</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_name, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:
        seq = <span class="hljs-built_in">int</span>(f.readline())

    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(DIR / <span class="hljs-string">'sequence'</span>, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:
        f.write(<span class="hljs-built_in">str</span>(seq + <span class="hljs-number">1</span>))
    <span class="hljs-keyword">return</span> seq


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_pause_data</span>(<span class="hljs-params">pause: <span class="hljs-built_in">bool</span>, seq: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:
    <span class="hljs-string">"""
    Generates data packet to pause or restart the fountain.

    The fountain will automatically restart in 10 mins.

    :param pause: If true, pause the fountain otherwise restart it.
    :param seq: current sequence number. must be greater than last one used.
    :return:
    """</span>
    signal = OFF <span class="hljs-keyword">if</span> pause <span class="hljs-keyword">else</span> ON
    seq = seq.to_bytes(<span class="hljs-number">2</span>, <span class="hljs-string">'big'</span>)
    <span class="hljs-keyword">return</span> MAGIC_NUMBER + PAUSE_CMD + seq + SOMETHING + signal + END

<span class="hljs-keyword">def</span> <span class="hljs-title function_">callback</span>(<span class="hljs-params">sender: BleakGATTCharacteristic, data: <span class="hljs-built_in">bytearray</span></span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"NOTIFY:  <span class="hljs-subst">{data.<span class="hljs-built_in">hex</span>()}</span>"</span>)



<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    scanner = BleakScanner()
    fountain = <span class="hljs-keyword">await</span> scanner.find_device_by_name(NAME)

    client = BleakClient(fountain)


    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'Connecting'</span>)
        <span class="hljs-keyword">await</span> client.connect()
        <span class="hljs-keyword">await</span> client.start_notify(<span class="hljs-number">16</span>, callback)

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'SENDING: <span class="hljs-subst">{INIT_MESSAGE.<span class="hljs-built_in">hex</span>()}</span>'</span>)
        <span class="hljs-keyword">await</span> client.write_gatt_char(WRITE_CHAR, INIT_MESSAGE)

        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">4</span>)

        <span class="hljs-built_in">print</span>(<span class="hljs-string">'Closing connection.'</span>)
        <span class="hljs-keyword">await</span> client.stop_notify(CHAR16)


    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(e)
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> client.disconnect()


asyncio.run(main())
</code></pre><p><strong>🎉 I can now pause the fountain without the app.</strong></p>
<h3>App display data</h3>
<p>The next part of the fountain's interface that I want to reverse engineer is the data it sends to the app to be
displayed. To do this, my plan is to capture the packet communication when the app starts up and compare the data to
what I see in the app and the differences between runs.</p>
<figure>
<img src="/images/side-projects/cat-fountain/startup-data.png" alt="startup-data.png">
<figcaption>Looking at app startup packets.  The data that populates the apps.</figcaption>
</figure>

<br>


<figure>
<img src="/images/side-projects/cat-fountain/startup-comparisons.png" alt="startup-comparisons.png">
<figcaption>Comparing a few startup communications with app states</figcaption>
</figure>

<p><strong>📌 I'm here now</strong></p>
<h2>Extra notes about packets</h2>
<p><strong>When the app connects, it sends these two every time.</strong></p>
<pre><code class="hljs">fafcfdd501000000fb
fafcfd560101080000008767fea7039dfb
</code></pre><p><strong>The first signal seems to trigger this response:</strong></p>
<pre><code class="hljs">fafcfdd5020016000000000005f73b713230323430353135573231313237fb
</code></pre><p><em>I captured this same response value on two of the app init captures. The third init attempt didn't capture any response
at this point.</em></p>
<p>like other data, it starts with <code>fafcfd</code></p>
<p>The first byte seems to represent an identifier of what the rest of the data is for - like a command name or endpoint or
something. Each response starts withe the same byte.</p>
<p>The sequence when the app connects:</p>
<ul>
<li><code>d5</code></li>
<li><code>56</code></li>
<li><code>54</code></li>
<li><code>c8</code></li>
<li><code>c9</code></li>
<li><code>d3</code></li>
<li><code>d4</code></li>
<li><code>d7</code></li>
<li><code>d8</code></li>
<li><em>(receives an <code>e6</code> response)</em></li>
<li><code>e6</code> - <em>final command, seems like an acknowledgment</em></li>
</ul>
<p>The next byte seems to be some sort of call/response sequence. The sender uses <code>01</code> and the replier uses <code>02</code></p>
<p>The next byte looks like a sequence that increments with each request.</p>
<p><strong>first response (SEQ = 00)</strong></p>
<pre><code class="hljs">1600000000000 5f73b7132303234303531355732313132 77
1600000000000 5f73b7132303234303531355732313132 37
</code></pre><p><strong>3rd command (only one that's different between two two runs i'm looking at)</strong></p>
<pre><code class="hljs">070000 2e82 5340 0800
070000 2e8b 25a4 0800
</code></pre><p><strong>5th response (SEQ = 05)</strong></p>
<pre><code class="hljs">18000000000000000000 0019ea6c0019df14 0000000000000000
18000000000000000000 0022b92c0022b160 0000000000000000
</code></pre><p><strong>6th response</strong></p>
<pre><code class="hljs">10000101 0000000000 19df1422 010000 007f
10000101 0000000000 22b1600c 010000 e9e7
</code></pre><p><strong>final response</strong></p>
<pre><code class="hljs">98 1e0001010000000000 19df16220100000081 03030102000005a0000528010000
a5 1e0001010000000000 22b1610c010000e9e8 03030102000005a0000528010000
</code></pre>8:["$","article",null,{"className":"content","children":[["$","div",null,{"className":"relative p-[3ch] border-3 my-8","children":[["$","$L10",null,{"src":{"src":"/_next/static/media/img.bf54b135.png","height":886,"width":1055,"blurDataURL":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAHCAMAAAACh/xsAAAABlBMVEVcXFxdXV3cuFAgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAH0lEQVR4nGNgZGRgACMQwQhCED6YhshBaJAKqARCDgADrAAcBuG12QAAAABJRU5ErkJggg==","blurWidth":8,"blurHeight":7},"className":"object-cover -z-20","fill":true,"alt":""}],["$","div",null,{"className":"bg-white/55 backdrop-blur-xs w-fit mx-auto px-2 py-0.5 ring-2 ring-black text-center","children":["$","h1",null,{"className":"font-bold text-4xl uppercase","children":"Reverse Engineering my Cat's Water Fountain"}]}]]}],["$","div",null,{"dangerouslySetInnerHTML":{"__html":"$11"}}],";"]}]
