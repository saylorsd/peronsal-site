{"pageProps":{"project":{"attributes":{"title":"Reverse Engineering my Cat's Water Fountain","slug":"cat-fountain","description":"My new pet water fountain comes with an app which is both neat and troublesome. I want to reverse engineer how it operates so I can use my own app to control and monitor it.\n","order":0},"body":"<p>I have one of <a href=\"https://petkit.com/products/eversweet-solo-2\">these water fountains</a> for my cat. It comes with an app,\nand from what I could tell, it was using Bluetooth Low Energy (Bluetooth LE, BLE) for communicating with the fountain. I\nreally don't\nwant to use the company's app for privacy and security reasons. I also think that reverse engineering the fountain's API\nwill lead to other fun projects like building a new app and integrating my own smart home features.</p>\n<p>So far, I've been able to reverse engineer a bit of how the fountain and app work. Here's my best attempt collect\nnotes and document what I did a while ago. It is not complete, but I plan to clean this up and add more in the future.</p>\n<h2>Packet Sniffing</h2>\n<p>I knew I would need to sniff the packets being sent between my phone and the fountain. Some web searching led\nme <a href=\"https://novelbits.io/nordic-ble-sniffer-guide-using-nrf52840-wireshark/\">a post</a> which led me to try\nthe packet sniffing software <a href=\"https://www.wireshark.org/\">Wireshark</a> with a BLE plugin, and\na <a href=\"https://www.nordicsemi.com/Products/Development-hardware/nrf52840-dongle\">nRF52840 BLE development dongle</a> from\nNordic Semiconductor.</p>\n<p>To use the dongle to sniff packets (i.e. simply listen to and report them), I need to install\nthe <a href=\"https://www.nordicsemi.com/Products/Development-tools/nRF-Sniffer-for-Bluetooth-LE\">sniffer firmware</a>\nusing <a href=\"https://www.nordicsemi.com/Products/Development-tools/nRF-Connect-for-Desktop\">Nordic's desktop software</a>.</p>\n<figure>\n<img src=\"/images/side-projects/cat-fountain/nrf.gif\" height=\"400px\" alt=\"NRF dongle sniffing away\">\n<figcaption>nRF dongle sniffing packets</figcaption>\n</figure>\n\n<p>With the sniffer running in wireshark without any further filtering, I was looking at a firehose of all the bluetooth\npackets flying around me. Luckily wireshark allows for lots of filters and I could filter to just the packets from and\nfor the fountain.</p>\n<figure>\n<img src=\"/images/side-projects/cat-fountain/sniffing.gif\" alt=\"Sniffing\">\n<figcaption>Wireshark output of communications between fountain and my phone</figcaption>\n</figure>\n\n\n<p>The next thing I did was explore the packets while playing with the app. I discovered that communication was done\nusing <a href=\"https://en.wikipedia.org/wiki/Bluetooth_Low_Energy#Software_model\">GATT</a> and from there I was able to narrow now\nthe packets to the ones I wanted as Wireshark labeled the protocol being used in the packet.</p>\n<p>Exploring the (G)ATT packets I found the payload data being sent and started to explore it. I updated Wireshark to\nreport the payload data and then I exported it to excel to play around with it.</p>\n<h2>Examining raw data</h2>\n<h3>Fountain control commands</h3>\n<p>I started playing with the data and a <a href=\"https://bleak.readthedocs.io/en/latest/\">Python BLE library</a> and was able to\nreverse engineer the On/Off switch of the fountain. One interesting thing I noticed was a few bytes used to keep track\nof a sequence. If you send a command with teh sequence bytes behind, the fountain will ignore it.</p>\n<p><em>This python script shows my breakdown of the bytes sent by the app and can send on and off requests to the fountain.</em></p>\n<pre><code class=\"hljs language-python\"><span class=\"hljs-keyword\">import</span> asyncio\n<span class=\"hljs-keyword\">import</span> os\n<span class=\"hljs-keyword\">from</span> pathlib <span class=\"hljs-keyword\">import</span> Path\n\n<span class=\"hljs-keyword\">from</span> bleak <span class=\"hljs-keyword\">import</span> BleakClient, BleakScanner, BleakGATTCharacteristic\n\nNAME = <span class=\"hljs-string\">'Petkit_CTW2'</span>\n\n<span class=\"hljs-comment\"># CHARACTERISTICS</span>\nCHAR13 = <span class=\"hljs-string\">'0000aaa2-0000-1000-8000-00805f9b34fb'</span>  <span class=\"hljs-comment\"># Petkit_CTW2_TX</span>\nCHAR16 = <span class=\"hljs-string\">'0000aaa1-0000-1000-8000-00805f9b34fb'</span>  <span class=\"hljs-comment\"># Petkit_CTW2_RX</span>\n\n<span class=\"hljs-comment\"># DESCRIPTORS</span>\nDESC15 = <span class=\"hljs-string\">'00002901-0000-1000-8000-00805f9b34fb'</span>  <span class=\"hljs-comment\"># CHAR13  - bytearray(b'Petkit_CTW2_TX')</span>\nDESC18 = <span class=\"hljs-string\">'00002902-0000-1000-8000-00805f9b34fb'</span>  <span class=\"hljs-comment\"># CHAR16  - bytearray(b'')</span>\nDESC19 = <span class=\"hljs-string\">'00002901-0000-1000-8000-00805f9b34fb'</span>  <span class=\"hljs-comment\"># CHAR16  - bytearray(b'Petkit_CTW2_RX')</span>\n\n<span class=\"hljs-comment\"># SERVICES</span>\nSERV12 = <span class=\"hljs-string\">'0000aaa0-0000-1000-8000-00805f9b34fb'</span>\n\n<span class=\"hljs-comment\"># DATA PARTS</span>\nMAGIC_NUMBER = <span class=\"hljs-string\">b'\\xFA\\xFC\\xFD'</span>\nPAUSE_CMD = <span class=\"hljs-string\">b'\\xDC'</span>\nSOMETHING = <span class=\"hljs-string\">b'\\x02\\x00'</span>\nON = <span class=\"hljs-string\">b'\\x01'</span>\nOFF = <span class=\"hljs-string\">b'\\x00'</span>\nEND = <span class=\"hljs-string\">b'\\x01\\xFB'</span>\n\nDIR = Path(os.path.dirname(os.path.realpath(__file__)))\n\nINIT_CMD = <span class=\"hljs-string\">b'\\xD5'</span>\n\nINIT_MESSAGE = MAGIC_NUMBER  + INIT_CMD + <span class=\"hljs-string\">b'\\x01\\x00\\x00\\x00\\xfb'</span>\n\n\nWRITE_CHAR = CHAR13\nREAD_CHAR = CHAR16\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_next_sequence</span>() -&gt; <span class=\"hljs-built_in\">int</span>:\n    file_name = DIR / <span class=\"hljs-string\">'sequence'</span>\n    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(file_name, <span class=\"hljs-string\">'r'</span>) <span class=\"hljs-keyword\">as</span> f:\n        seq = <span class=\"hljs-built_in\">int</span>(f.readline())\n\n    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(DIR / <span class=\"hljs-string\">'sequence'</span>, <span class=\"hljs-string\">'w'</span>) <span class=\"hljs-keyword\">as</span> f:\n        f.write(<span class=\"hljs-built_in\">str</span>(seq + <span class=\"hljs-number\">1</span>))\n    <span class=\"hljs-keyword\">return</span> seq\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_pause_data</span>(<span class=\"hljs-params\">pause: <span class=\"hljs-built_in\">bool</span>, seq: <span class=\"hljs-built_in\">int</span></span>) -&gt; <span class=\"hljs-built_in\">bytes</span>:\n    <span class=\"hljs-string\">\"\"\"\n    Generates data packet to pause or restart the fountain.\n\n    The fountain will automatically restart in 10 mins.\n\n    :param pause: If true, pause the fountain otherwise restart it.\n    :param seq: current sequence number. must be greater than last one used.\n    :return:\n    \"\"\"</span>\n    signal = OFF <span class=\"hljs-keyword\">if</span> pause <span class=\"hljs-keyword\">else</span> ON\n    seq = seq.to_bytes(<span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">'big'</span>)\n    <span class=\"hljs-keyword\">return</span> MAGIC_NUMBER + PAUSE_CMD + seq + SOMETHING + signal + END\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">callback</span>(<span class=\"hljs-params\">sender: BleakGATTCharacteristic, data: <span class=\"hljs-built_in\">bytearray</span></span>):\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">f\"NOTIFY:  <span class=\"hljs-subst\">{data.<span class=\"hljs-built_in\">hex</span>()}</span>\"</span>)\n\n\n\n<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">main</span>():\n    scanner = BleakScanner()\n    fountain = <span class=\"hljs-keyword\">await</span> scanner.find_device_by_name(NAME)\n\n    client = BleakClient(fountain)\n\n\n    <span class=\"hljs-keyword\">try</span>:\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">'Connecting'</span>)\n        <span class=\"hljs-keyword\">await</span> client.connect()\n        <span class=\"hljs-keyword\">await</span> client.start_notify(<span class=\"hljs-number\">16</span>, callback)\n\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">f'SENDING: <span class=\"hljs-subst\">{INIT_MESSAGE.<span class=\"hljs-built_in\">hex</span>()}</span>'</span>)\n        <span class=\"hljs-keyword\">await</span> client.write_gatt_char(WRITE_CHAR, INIT_MESSAGE)\n\n        <span class=\"hljs-keyword\">await</span> asyncio.sleep(<span class=\"hljs-number\">4</span>)\n\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">'Closing connection.'</span>)\n        <span class=\"hljs-keyword\">await</span> client.stop_notify(CHAR16)\n\n\n    <span class=\"hljs-keyword\">except</span> Exception <span class=\"hljs-keyword\">as</span> e:\n        <span class=\"hljs-built_in\">print</span>(e)\n    <span class=\"hljs-keyword\">finally</span>:\n        <span class=\"hljs-keyword\">await</span> client.disconnect()\n\n\nasyncio.run(main())\n</code></pre><p><strong>ðŸŽ‰ I can now pause the fountain without the app.</strong></p>\n<h3>App display data</h3>\n<p>The next part of the fountain's interface that I want to reverse engineer is the data it sends to the app to be\ndisplayed. To do this, my plan is to capture the packet communication when the app starts up and compare the data to\nwhat I see in the app and the differences between runs.</p>\n<figure>\n<img src=\"/images/side-projects/cat-fountain/startup-data.png\" alt=\"startup-data.png\">\n<figcaption>Looking at app startup packets.  The data that populates the apps.</figcaption>\n</figure>\n\n<br>\n\n\n<figure>\n<img src=\"/images/side-projects/cat-fountain/startup-comparisons.png\" alt=\"startup-comparisons.png\">\n<figcaption>Comparing a few startup communications with app states</figcaption>\n</figure>\n\n<p><strong>ðŸ“Œ I'm here now</strong></p>\n<h2>Extra notes about packets</h2>\n<p><strong>When the app connects, it sends these two every time.</strong></p>\n<pre><code class=\"hljs\">fafcfdd501000000fb\nfafcfd560101080000008767fea7039dfb\n</code></pre><p><strong>The first signal seems to trigger this response:</strong></p>\n<pre><code class=\"hljs\">fafcfdd5020016000000000005f73b713230323430353135573231313237fb\n</code></pre><p><em>I captured this same response value on two of the app init captures. The third init attempt didn't capture any response\nat this point.</em></p>\n<p>like other data, it starts with <code>fafcfd</code></p>\n<p>The first byte seems to represent an identifier of what the rest of the data is for - like a command name or endpoint or\nsomething. Each response starts withe the same byte.</p>\n<p>The sequence when the app connects:</p>\n<ul>\n<li><code>d5</code></li>\n<li><code>56</code></li>\n<li><code>54</code></li>\n<li><code>c8</code></li>\n<li><code>c9</code></li>\n<li><code>d3</code></li>\n<li><code>d4</code></li>\n<li><code>d7</code></li>\n<li><code>d8</code></li>\n<li><em>(receives an <code>e6</code> response)</em></li>\n<li><code>e6</code> - <em>final command, seems like an acknowledgment</em></li>\n</ul>\n<p>The next byte seems to be some sort of call/response sequence. The sender uses <code>01</code> and the replier uses <code>02</code></p>\n<p>The next byte looks like a sequence that increments with each request.</p>\n<p><strong>first response (SEQ = 00)</strong></p>\n<pre><code class=\"hljs\">1600000000000 5f73b7132303234303531355732313132 77\n1600000000000 5f73b7132303234303531355732313132 37\n</code></pre><p><strong>3rd command (only one that's different between two two runs i'm looking at)</strong></p>\n<pre><code class=\"hljs\">070000 2e82 5340 0800\n070000 2e8b 25a4 0800\n</code></pre><p><strong>5th response (SEQ = 05)</strong></p>\n<pre><code class=\"hljs\">18000000000000000000 0019ea6c0019df14 0000000000000000\n18000000000000000000 0022b92c0022b160 0000000000000000\n</code></pre><p><strong>6th response</strong></p>\n<pre><code class=\"hljs\">10000101 0000000000 19df1422 010000 007f\n10000101 0000000000 22b1600c 010000 e9e7\n</code></pre><p><strong>final response</strong></p>\n<pre><code class=\"hljs\">98 1e0001010000000000 19df16220100000081 03030102000005a0000528010000\na5 1e0001010000000000 22b1610c010000e9e8 03030102000005a0000528010000\n</code></pre>"}},"__N_SSG":true}